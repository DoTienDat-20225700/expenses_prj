{% extends 'ep1/base.html' %}
{% load humanize %}
{% block content %}

<div class="row mb-4">
  <div class="col-md-6">
    <h2><i class="fas fa-list me-2"></i>Danh sách chi tiêu</h2>
  </div>
  <div class="col-md-6 text-end">
    <form method="post" class="d-inline-block me-2">
      {% csrf_token %}
      <div class="input-group input-group-sm d-inline-flex align-items-stretch">
        <span class="input-group-text fw-bold">₫</span>
        {{ b_form.total }} 
        <button name="budget_submit" class="btn btn-success" type="submit" title="Lưu ngân sách">
          <i class="fas fa-check"></i>
        </button>
      </div>
    </form>
    <a href="{% url 'ep1:export_expenses' %}?{{ request.GET.urlencode }}" class="btn btn-success shadow-sm me-1" title="Xuất ra Excel">
      <i class="fas fa-file-excel me-1"></i> Xuất Excel
    </a>
    <a href="{% url 'ep1:add_ep1' %}" class="btn btn-primary shadow-sm">
      <i class="fas fa-plus me-1"></i> Thêm mới
    </a>
  </div>
</div>

<form method="get" id="list-section">    
    <div class="card mb-4 shadow-sm border-0">
        <div class="card-body p-3 rounded">
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label small fw-bold text-muted">Sắp xếp tiền</label>
                    <select name="sort_amount" class="form-select" onchange="this.form.submit()">
                        <option value="">Mặc định</option>
                        <option value="asc" {% if sort_amount == 'asc' %}selected{% endif %}>Thấp đến Cao</option>
                        <option value="desc" {% if sort_amount == 'desc' %}selected{% endif %}>Cao đến Thấp</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label small fw-bold text-muted">Danh mục</label>
                    <select name="category" class="form-select" onchange="this.form.submit()">
                        <option value="">Tất cả danh mục</option>
                        {% for cat in categories %}
                        <option value="{{ cat.id }}" {% if selected_category == cat.id %}selected{% endif %}>
                            {{ cat.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-4">
                    <label class="form-label small fw-bold text-muted">Khoảng thời gian</label>
                    <div class="input-group">
                        <input type="date" name="date_from" class="form-control" 
                               value="{{ date_from }}" onchange="this.form.submit()" />
                        <span class="input-group-text">-</span>
                        <input type="date" name="date_to" class="form-control" 
                               value="{{ date_to }}" onchange="this.form.submit()" />
                    </div>
                </div>

                <div class="col-md-2 text-end">
                    <a href="{% url 'ep1:ep1_lists' %}" class="btn btn-secondary w-100">
                        <i class="fas fa-sync-alt me-1"></i> Đặt lại
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="table-responsive rounded shadow-sm card">
        <table class="table table-hover align-middle mb-0">
            <thead>
                <tr>
                    <th class="py-3 ps-3" style="width: 20%;">Số tiền</th>
                    <th class="py-3" style="width: 30%;">Mô tả</th>
                    <th class="py-3" style="width: 20%;">Danh mục</th>
                    <th class="py-3" style="width: 20%;">Ngày</th>
                    <th class="py-3 text-center" style="width: 10%;">Hành động</th>
                </tr>
            </thead>
            <tbody>
                {% for expense in expenses %}
                <tr>
                    <td class="ps-3 fw-bold text-primary">{{ expense.amount|floatformat:0|intcomma:0 }} ₫</td>
                    <td class="text-muted">{{ expense.description|truncatechars:40|default:"--" }}</td>
                    <td>
                        <span class="badge bg-primary bg-opacity-10 text-primary px-3 py-2 rounded-pill">
                            {{ expense.category }}
                        </span>
                    </td>
                    <td>{{ expense.date|date:"d/m/Y" }}</td>
                    <td class="text-center">
                        <div class="btn-group">
                            <a href="{% url 'ep1:edit_ep1' expense.id %}" class="btn btn-sm btn-outline-primary border-0" data-bs-toggle="tooltip" title="Sửa">
                                <i class="fas fa-pen"></i>
                            </a>
                            <a href="{% url 'ep1:delete_ep1' expense.id %}" class="btn btn-sm btn-outline-danger border-0" data-bs-toggle="tooltip" title="Xóa">
                                <i class="fas fa-trash"></i>
                            </a>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="text-center py-5 text-muted">
                        <div class="mb-3"><i class="fas fa-folder-open fa-3x opacity-25"></i></div>
                        <p class="mb-0">Chưa có dữ liệu chi tiêu nào.</p>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% if page_obj.has_other_pages %}
    <nav aria-label="Page navigation" class="mt-4">
      <ul class="pagination justify-content-center">
        
        {% if page_obj.has_previous %}
        <li class="page-item">
          <a class="page-link shadow-sm" href="?page={{ page_obj.previous_page_number }}&category={{ selected_category|default:'' }}&sort_amount={{ sort_amount|default:'' }}&date_from={{ date_from|default:'' }}&date_to={{ date_to|default:'' }}#list-section">
            <i class="fas fa-chevron-left"></i>
          </a>
        </li>
        {% else %}
        <li class="page-item disabled"><span class="page-link shadow-sm"><i class="fas fa-chevron-left"></i></span></li>
        {% endif %}

        {% for i in page_obj.paginator.page_range %}
          {% if page_obj.number == i %}
          <li class="page-item active"><span class="page-link shadow-sm fw-bold">{{ i }}</span></li>
          {% else %}
          <li class="page-item">
            <a class="page-link shadow-sm" href="?page={{ i }}&category={{ selected_category|default:'' }}&sort_amount={{ sort_amount|default:'' }}&date_from={{ date_from|default:'' }}&date_to={{ date_to|default:'' }}#list-section">{{ i }}</a>
          </li>
          {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
        <li class="page-item">
          <a class="page-link shadow-sm" href="?page={{ page_obj.next_page_number }}&category={{ selected_category|default:'' }}&sort_amount={{ sort_amount|default:'' }}&date_from={{ date_from|default:'' }}&date_to={{ date_to|default:'' }}#list-section">
            <i class="fas fa-chevron-right"></i>
          </a>
        </li>
        {% else %}
        <li class="page-item disabled"><span class="page-link shadow-sm"><i class="fas fa-chevron-right"></i></span></li>
        {% endif %}
      </ul>
    </nav>
    {% endif %}
</form>

<div class="row mt-4">
    <div class="col-md-4 mb-4">
        <div class="card border-left-primary h-100 shadow-sm">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-primary fw-bold text-uppercase small">Tổng chi tiêu</h6>
                        <h3 class="mb-0 fw-bold">{{ total_spent|floatformat:0|intcomma:0 }} ₫</h3>
                    </div>
                    <i class="fas fa-coins fa-2x text-muted opacity-25"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4 mb-4">
        <div class="card border-left-success h-100 shadow-sm">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-success fw-bold text-uppercase small">Chi nhiều nhất</h6>
                        <h3 class="mb-0 fw-bold">{{ top_category }}</h3>
                    </div>
                    <i class="fas fa-chart-line fa-2x text-muted opacity-25"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4 mb-4">
        <div class="card border-left-info h-100 shadow-sm">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-info fw-bold text-uppercase small">Ngân sách còn lại</h6>
                        <h3 class="mb-0 fw-bold">{{ remaining|floatformat:0|intcomma:0}} ₫</h3>
                    </div>
                    <i class="fas fa-wallet fa-2x text-muted opacity-25"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6 mb-4 mb-md-0">
        <div class="card h-100 shadow-sm">
            <div class="card-header py-3">
                <h6 class="m-0 fw-bold text-primary"><i class="fas fa-chart-pie me-1"></i> Tỉ lệ chi tiêu</h6>
            </div>
            <div class="card-body">
                <div style="height: 300px;">
                    <canvas id="expenseChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card h-100 shadow-sm">
            <div class="card-header py-3">
                <h6 class="m-0 fw-bold text-primary"><i class="fas fa-chart-bar me-1"></i> Chi tiêu theo ngày</h6>
            </div>
            <div class="card-body">
                <div style="height: 300px;">
                    <canvas id="barChartDay"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const ctxPie = document.getElementById('expenseChart').getContext('2d');
    new Chart(ctxPie, {
        type: 'doughnut',
        data: {
            labels: {{ chart_labels|safe }},
            datasets: [{
                data: {{ chart_data|safe }},
                backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796'],
                borderWidth: 0,
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom' }, cutout: '70%' }
        }
    });

    const ctxDay = document.getElementById('barChartDay').getContext('2d');
    new Chart(ctxDay, {
        type: 'bar',
        data: {
            labels: {{ chart_labels_day|safe }},
            datasets: [{
                label: 'Chi tiêu',
                data: {{ chart_data_day|safe }},
                backgroundColor: '#4e73df',
                borderRadius: 4, barPercentage: 0.6
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, grid: { borderDash: [2, 4], drawBorder: false } },
                x: { grid: { display: false } }
            },
            plugins: { legend: { display: false } }
        }
    });

    const input = document.querySelector('input[name="total"]');
    function formatNumber(value) {
        value = value.replace(/[^\d]/g, "");
        return value.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }
    input.addEventListener('input', function() { this.value = formatNumber(this.value); });
    input.closest('form').addEventListener('submit', function() { input.value = input.value.replace(/,/g, ''); });
});
</script>

{% endblock %}