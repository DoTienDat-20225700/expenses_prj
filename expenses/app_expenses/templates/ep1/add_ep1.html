{% extends 'ep1/base.html' %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-plus-circle me-1"></i> Thêm chi tiêu mới
                </h6>
            </div>
            <div class="card-body">
                <form method="post" class="needs-validation" novalidate>
                    {% csrf_token %}
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="id_amount" class="form-label">Số tiền (₫)</label>
                            <div class="input-group">
                                <input type="text" class="form-control" name="amount" id="id_amount" 
                                       required value="{{ form.amount.value|default_if_none:'' }}">
                                <span class="input-group-text">₫</span>
                                <div class="invalid-feedback">
                                    Vui lòng nhập số tiền hợp lệ (tối thiểu 1,000₫)
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="id_date" class="form-label">Ngày chi tiêu</label>
                            <input type="date" class="form-control" name="date" id="id_date" 
                                   required value="{{ form.date.value|default_if_none:''|date:'Y-m-d' }}">
                            <div class="invalid-feedback">
                                Vui lòng chọn ngày
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="id_description" class="form-label">Mô tả</label>
                        <textarea class="form-control" name="description" id="id_description" 
                                  rows="3">{{ form.description.value|default_if_none:'' }}</textarea>
                    </div>
                    
                    <div class="mb-4">
                        <label for="id_category" class="form-label">Danh mục</label>
                        <select class="form-select" name="category" id="id_category" required>
                            <option value="" selected disabled>-- Chọn danh mục --</option>
                            {% for category in form.category.field.queryset %}
                                <option value="{{ category.id }}" 
                                    {% if form.category.value == category.id %}selected{% endif %}>
                                    {{ category.name }}
                                </option>
                            {% endfor %}
                        </select>
                        <div class="invalid-feedback">
                            Vui lòng chọn danh mục
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{% url 'ep1:ep1_lists' %}" class="btn btn-secondary me-md-2">
                            <i class="fas fa-times me-1"></i> Hủy bỏ
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i> Lưu chi tiêu
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    /* Tự động thêm dấu phẩy mỗi 3 chữ số khi nhập
       Loại bỏ dấu phẩy khi submit form để gửi về backend giá trị số thuần */
(function () {
    'use strict'

    var forms = document.querySelectorAll('.needs-validation')
    Array.prototype.slice.call(forms)
        .forEach(function (form) {
            form.addEventListener('submit', function (event) {
                if (!form.checkValidity()) {
                    event.preventDefault()
                    event.stopPropagation()
                }
                form.classList.add('was-validated')
            }, false)
        })
})();

document.addEventListener('DOMContentLoaded', function() {
    const input = document.getElementById('id_amount');

    function formatNumberWithCommas(value) {
        return value.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    input.addEventListener('input', function() {
        let value = this.value.replace(/,/g, '');
        if (isNaN(value)) {
            this.value = '';
            return;
        }
        this.value = formatNumberWithCommas(value);
    });

    const form = input.closest('form');
    form.addEventListener('submit', function() {
        input.value = input.value.replace(/,/g, '');
    });
});
</script>
{% endblock %}