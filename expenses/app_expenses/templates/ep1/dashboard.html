{% extends 'ep1/base.html' %} {% load static %} {% load humanize %} {% load
widget_tweaks %} {% block content %}

<div class="row g-4">
  {% if active_announcements %}
  <div class="col-12">
    {% for announcement in active_announcements %}
    <div
      class="alert alert-{{ announcement.priority }} alert-dismissible fade show shadow-sm border-0 d-flex align-items-center"
      role="alert"
    >
      <i class="fas fa-bullhorn me-2 fs-5"></i>
      <div>
        <strong>{{ announcement.title }}</strong> - {{ announcement.content }}
      </div>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <div
    class="col-12 d-flex flex-wrap justify-content-between align-items-center gap-3"
  >
    <h3 class="fw-bold mb-0 text-main">
      <i class="fas fa-chart-pie me-2 text-primary"></i>Tổng Quan Tài Chính
    </h3>

    <form method="post" class="d-inline-block me-2">
      {% csrf_token %}
      <div class="input-group input-group-sm d-inline-flex align-items-stretch">
        <span class="input-group-text fw-bold">₫</span>
        {{ b_form.total }}
        <button
          name="budget_submit"
          class="btn btn-success"
          type="submit"
          title="Lưu ngân sách"
        >
          <i class="fas fa-check"></i>
        </button>
      </div>
    </form>
  </div>

  <div class="col-md-6 col-lg-3">
    <div class="card h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start mb-3">
          <div>
            <p class="text-muted mb-1 small text-uppercase fw-bold">
              Chi Tiêu Tháng
            </p>
            <h3 class="fw-bold mb-0 text-danger">
              {{ this_month_expenses|floatformat:0|intcomma }} ₫
            </h3>
          </div>
          <div
            class="rounded-circle p-3 d-flex align-items-center justify-content-center"
            style="
              width: 50px;
              height: 50px;
              background: rgba(239, 68, 68, 0.1);
            "
          >
            <i class="fas fa-wallet text-danger fs-5"></i>
          </div>
        </div>
        <div class="d-flex align-items-center small text-muted">
          <i class="fas fa-history me-1"></i>
          Tổng ví: {{ total_expenses|floatformat:0|intcomma }} ₫
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-6 col-lg-3">
    <div class="card h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start mb-3">
          <div>
            <p class="text-muted mb-1 small text-uppercase fw-bold">
              Thu Nhập Tháng
            </p>
            <h3 class="fw-bold mb-0 text-success">
              {{ this_month_income|floatformat:0|intcomma }} ₫
            </h3>
          </div>
          <div
            class="rounded-circle p-3 d-flex align-items-center justify-content-center"
            style="
              width: 50px;
              height: 50px;
              background: rgba(16, 185, 129, 0.1);
            "
          >
            <i class="fas fa-money-bill-wave text-success fs-5"></i>
          </div>
        </div>
        <div class="d-flex align-items-center small text-muted">
          <i class="fas fa-history me-1"></i>
          Tổng ví: {{ total_income|floatformat:0|intcomma }} ₫
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-6 col-lg-3">
    <div class="card h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start mb-3">
          <div>
            <p class="text-muted mb-1 small text-uppercase fw-bold">
              Số Dư Hiện Tại
            </p>
            <h3
              class="fw-bold mb-0 {% if balance >= 0 %}text-success{% else %}text-danger{% endif %}"
            >
              {{ balance|floatformat:0|intcomma }} ₫
            </h3>
          </div>
          <div
            class="rounded-circle p-3 d-flex align-items-center justify-content-center"
            style="width: 50px; height: 50px; background: {% if balance >= 0 %}rgba(16, 185, 129, 0.1){% else %}rgba(239, 68, 68, 0.1){% endif %};"
          >
            <i
              class="fas fa-piggy-bank {% if balance >= 0 %}text-success{% else %}text-danger{% endif %} fs-5"
            ></i>
          </div>
        </div>
        <p class="small text-muted mb-0">Thu nhập - Chi tiêu</p>
      </div>
    </div>
  </div>

  <div class="col-md-6 col-lg-3">
    <div class="card h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start mb-2">
          <div>
            <p class="text-muted mb-1 small text-uppercase fw-bold">
              Ngân Sách
            </p>
            <h3 class="fw-bold mb-0 text-primary">
              {{ budget.total|floatformat:0|intcomma }} ₫
            </h3>
          </div>
          <div
            class="rounded-circle p-3 d-flex align-items-center justify-content-center"
            style="
              width: 50px;
              height: 50px;
              background: rgba(59, 130, 246, 0.1);
            "
          >
            <i class="fas fa-bullseye text-primary fs-5"></i>
          </div>
        </div>

        {% if budget.total > 0 %}
        <div
          class="progress mb-2 rounded-pill"
          style="height: 8px; background-color: var(--border-color)"
        >
          <div
            class="progress-bar rounded-pill {% if budget_percentage > 100 %}bg-danger{% elif budget_percentage > 70 %}bg-warning{% else %}bg-primary{% endif %}"
            role="progressbar"
            style="width: {{ budget_percentage|floatformat:0 }}%"
            aria-valuenow="{{ budget_percentage|floatformat:0 }}"
            aria-valuemin="0"
            aria-valuemax="100"
          ></div>
        </div>
        <div class="d-flex justify-content-between small fw-bold">
          <span class="text-muted"
            >Đã tiêu: {{ budget_percentage|floatformat:0 }}%</span
          >
          <span
            class="{% if budget_remaining >= 0 %}text-success{% else %}text-danger{% endif %}"
          >
            Còn: {{ budget_remaining|floatformat:0|intcomma }}
          </span>
        </div>
        {% else %}
        <p class="small text-muted mb-0 fst-italic">Chưa thiết lập ngân sách</p>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-lg-6">
    <div class="card h-100">
      <div class="card-header border-0 pt-4">
        <h5 class="fw-bold mb-0 text-main">
          <i class="fas fa-chart-pie me-2 text-primary"></i>Phân Bố Chi Tiêu
        </h5>
      </div>
      <div class="card-body">
        <div style="height: 300px">
          <canvas id="categoryChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-6">
    <div class="card h-100">
      <div class="card-header border-0 pt-4">
        <h5 class="fw-bold mb-0 text-main">
          <i class="fas fa-chart-area me-2 text-primary"></i>Xu Hướng 6 Tháng
        </h5>
      </div>
      <div class="card-body">
        <div style="height: 300px">
          <canvas id="incomeExpenseChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-6">
    <div class="card h-100">
      <div class="card-header border-0 pt-4">
        <h5 class="fw-bold mb-0 text-main">
          <i class="fas fa-fire me-2 text-danger"></i>Top Danh Mục Tốn Kém
        </h5>
      </div>
      <div class="card-body p-0">
        {% if top_categories %}
        <div class="list-group list-group-flush rounded-bottom-4">
          {% for cat in top_categories %}
          <div
            class="list-group-item d-flex justify-content-between align-items-center px-4 py-3 bg-transparent"
          >
            <span class="badge category-badge px-3 py-2 rounded-pill shadow-sm">
              {{ cat.category__name|default:"Không xác định" }}
            </span>
            <span class="fw-bold text-main">
              {{ cat.total|floatformat:0|intcomma }} ₫
            </span>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-5 text-muted">
          <i class="fas fa-inbox fs-1 mb-2 opacity-50"></i>
          <p>Chưa có dữ liệu</p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-lg-6">
    <div class="card h-100">
      <div class="card-header border-0 pt-4">
        <h5 class="fw-bold mb-0 text-main">
          <i class="fas fa-clock me-2 text-info"></i>Giao Dịch Mới Nhất
        </h5>
      </div>
      <div class="card-body p-0">
        <div class="list-group list-group-flush rounded-bottom-4">
          {% for expense in recent_expenses %}
          <div
            class="list-group-item d-flex justify-content-between align-items-center px-4 py-3 bg-transparent"
          >
            <div class="d-flex align-items-center">
              <div
                class="rounded-circle bg-danger bg-opacity-10 p-2 me-3 text-danger"
              >
                <i class="fas fa-arrow-down small"></i>
              </div>
              <div>
                <div class="fw-bold text-main">
                  {{ expense.category.name|default:"Khác" }}
                </div>
                <small class="text-muted"
                  >{{ expense.date|date:"d/m/Y" }}</small
                >
              </div>
            </div>
            <span class="text-danger fw-bold">
              -{{ expense.amount|floatformat:0|intcomma }} ₫
            </span>
          </div>
          {% endfor %} {% for income in recent_income %}
          <div
            class="list-group-item d-flex justify-content-between align-items-center px-4 py-3 bg-transparent"
          >
            <div class="d-flex align-items-center">
              <div
                class="rounded-circle bg-success bg-opacity-10 p-2 me-3 text-success"
              >
                <i class="fas fa-arrow-up small"></i>
              </div>
              <div>
                <div class="fw-bold text-main">
                  {{ income.source.name|default:"Thu nhập" }}
                </div>
                <small class="text-muted">{{ income.date|date:"d/m/Y" }}</small>
              </div>
            </div>
            <span class="text-success fw-bold">
              +{{ income.amount|floatformat:0|intcomma }} ₫
            </span>
          </div>
          {% endfor %}
        </div>

        {% if not recent_expenses and not recent_income %}
        <div class="text-center py-5 text-muted">
          <i class="fas fa-receipt fs-1 mb-2 opacity-50"></i>
          <p>Chưa có giao dịch nào</p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  {% if upcoming_recurring %}
  <div class="col-12">
    <div class="card">
      <div class="card-header border-0 pt-4">
        <h5 class="fw-bold mb-0 text-main">
          <i class="fas fa-calendar-alt me-2 text-warning"></i>Sắp Đến Hạn Thanh
          Toán
        </h5>
      </div>
      <div class="card-body">
        <div class="row g-3">
          {% for recurring in upcoming_recurring %}
          <div class="col-md-6 col-lg-4">
            <div
              class="p-3 rounded-4 border border-warning bg-warning bg-opacity-10 d-flex justify-content-between align-items-center"
            >
              <div>
                <h6 class="fw-bold mb-1 text-main">{{ recurring.name }}</h6>
                <div class="text-danger fw-bold mb-1">
                  {{ recurring.amount|floatformat:0|intcomma }} ₫
                </div>
                <small class="text-muted">
                  <i class="far fa-clock me-1"></i>{{ recurring.next_due_date|date:"d/m/Y" }}
                </small>
              </div>
              <span class="badge bg-warning text-dark shadow-sm">
                {{ recurring.get_frequency_display }}
              </span>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <div class="col-12">
    <div class="card">
      <div class="card-body py-4">
        <h5 class="fw-bold mb-4 text-center text-main">Thao Tác Nhanh</h5>
        <div class="row g-3 justify-content-center">
          <div class="col-6 col-md-3 col-lg-2">
            <a
              href="{% url 'ep1:add_ep1' %}"
              class="btn btn-danger w-100 py-3 shadow-sm h-100 d-flex flex-column align-items-center justify-content-center gap-2"
            >
              <i class="fas fa-minus-circle fs-4"></i>
              <span>Chi Tiêu</span>
            </a>
          </div>
          <div class="col-6 col-md-3 col-lg-2">
            <a
              href="{% url 'ep1:add_income' %}"
              class="btn btn-success w-100 py-3 shadow-sm h-100 d-flex flex-column align-items-center justify-content-center gap-2"
            >
              <i class="fas fa-plus-circle fs-4"></i>
              <span>Thu Nhập</span>
            </a>
          </div>
          <div class="col-6 col-md-3 col-lg-2">
            <a
              href="{% url 'ep1:add_recurring' %}"
              class="btn btn-warning w-100 py-3 shadow-sm h-100 d-flex flex-column align-items-center justify-content-center gap-2 text-dark"
            >
              <i class="fas fa-sync-alt fs-4"></i>
              <span>Định Kỳ</span>
            </a>
          </div>
          <div class="col-6 col-md-3 col-lg-2">
            <a
              href="{% url 'ep1:ep1_lists' %}"
              class="btn btn-primary w-100 py-3 shadow-sm h-100 d-flex flex-column align-items-center justify-content-center gap-2"
            >
              <i class="fas fa-list-ul fs-4"></i>
              <span>Chi Tiết</span>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // 1. Format Input Ngân sách
    const input = document.querySelector('input[name="total"]');
    function formatNumber(value) {
      value = value.replace(/[^\d]/g, "");
      return value.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }
    if (input) {
      // Format ban đầu nếu có giá trị
      if (input.value) input.value = formatNumber(input.value);

      input.addEventListener("input", function () {
        this.value = formatNumber(this.value);
      });
      // Trước khi submit thì xóa dấu phẩy để backend đọc được số
      input.closest("form").addEventListener("submit", function () {
        input.value = input.value.replace(/,/g, "");
      });
    }

    // 2. Biểu đồ Danh mục (Doughnut)
    fetch("{% url 'ep1:chart_category' %}")
      .then((res) => res.json())
      .then((data) => {
        const ctx = document.getElementById("categoryChart").getContext("2d");
        new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: data.labels,
            datasets: [
              {
                data: data.data,
                backgroundColor: [
                  "#10b981",
                  "#3b82f6",
                  "#f59e0b",
                  "#ef4444",
                  "#8b5cf6",
                  "#ec4899",
                  "#6366f1",
                  "#14b8a6",
                  "#f97316",
                  "#64748b",
                ],
                borderWidth: 2,
                borderColor: "transparent",
                hoverOffset: 10,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "bottom",
                labels: { usePointStyle: true, padding: 20 },
              },
            },
            cutout: "65%",
            layout: { padding: 10 },
          },
        });
      });

    // 3. Biểu đồ Xu hướng (Line/Area)
    fetch("{% url 'ep1:chart_income_expense' %}")
      .then((res) => res.json())
      .then((data) => {
        const ctx = document
          .getElementById("incomeExpenseChart")
          .getContext("2d");

        // Tạo gradient cho đẹp
        let gradientIncome = ctx.createLinearGradient(0, 0, 0, 400);
        gradientIncome.addColorStop(0, "rgba(16, 185, 129, 0.4)");
        gradientIncome.addColorStop(1, "rgba(16, 185, 129, 0.0)");

        let gradientExpense = ctx.createLinearGradient(0, 0, 0, 400);
        gradientExpense.addColorStop(0, "rgba(239, 68, 68, 0.4)");
        gradientExpense.addColorStop(1, "rgba(239, 68, 68, 0.0)");

        new Chart(ctx, {
          type: "line",
          data: {
            labels: data.labels,
            datasets: [
              {
                label: "Thu Nhập",
                data: data.income,
                borderColor: "#10b981",
                backgroundColor: gradientIncome,
                tension: 0.4,
                fill: true,
                pointRadius: 4,
                pointBackgroundColor: "#fff",
                pointBorderColor: "#10b981",
                pointBorderWidth: 2,
              },
              {
                label: "Chi Tiêu",
                data: data.expenses,
                borderColor: "#ef4444",
                backgroundColor: gradientExpense,
                tension: 0.4,
                fill: true,
                pointRadius: 4,
                pointBackgroundColor: "#fff",
                pointBorderColor: "#ef4444",
                pointBorderWidth: 2,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: "index", intersect: false },
            plugins: {
              legend: {
                position: "top",
                align: "end",
                labels: { usePointStyle: true },
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: { borderDash: [2, 4], color: "rgba(0,0,0,0.05)" },
                ticks: { padding: 10 },
              },
              x: {
                grid: { display: false },
              },
            },
          },
        });
      });
  });
</script>
{% endblock %}
