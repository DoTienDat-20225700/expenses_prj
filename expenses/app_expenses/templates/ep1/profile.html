{% extends 'ep1/base.html' %} {% load widget_tweaks %} {% block content %}
<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-lg-11">
      <div class="card shadow border-0 rounded-4 overflow-hidden">
        <div class="card-header bg-transparent border-bottom py-3">
          <h5 class="mb-0 fw-bold text-main">
            <i class="fas fa-user-circle me-2 text-primary"></i>Hồ Sơ Cá Nhân
          </h5>
        </div>

        <div class="card-body p-0">
          <form method="post" enctype="multipart/form-data">
            {% csrf_token %}

            <div class="row g-0">
              <div
                class="col-md-4 profile-left-col border-end d-flex flex-column align-items-center py-5"
              >
                <div class="avatar-wrapper mb-3 position-relative">
                  <img
                    id="avatar-preview"
                    src="{% if user.profile.avatar %}{{ user.profile.avatar.url }}{% else %}/media/avatars/default.png{% endif %}"
                    class="rounded-circle img-thumbnail border-0 shadow"
                    style="
                      width: 160px;
                      height: 160px;
                      object-fit: cover;
                      cursor: pointer;
                    "
                    alt="Avatar"
                    onclick="openImagePreview()"
                  />

                  <label
                    for="id_avatar_field"
                    class="btn-camera shadow-sm"
                    title="Thay đổi ảnh"
                  >
                    <i class="fas fa-camera"></i>
                  </label>
                </div>

                {% render_field p_form.avatar id="id_avatar_field"
                accept="image/*" onchange="previewImage(this);"
                style="display:none;" %}

                <h4 class="fw-bold mb-1 user-name-text">{{ user.username }}</h4>
                <p class="text-muted small mb-3">
                  <i class="fas fa-clock me-1"></i>Tham gia: {{
                  user.date_joined|date:"d/m/Y" }}
                </p>

                {% if p_form.instance.avatar %}
                <div
                  class="mt-2 px-3 py-2 rounded-pill shadow-sm border d-flex align-items-center switch-box"
                >
                  <div
                    class="form-check form-switch m-0 d-flex align-items-center"
                  >
                    <input
                      class="form-check-input me-2"
                      type="checkbox"
                      name="{{ p_form.avatar.html_name }}-clear"
                      id="deleteAvatarSwitch"
                      style="width: 35px; height: 20px"
                    />
                    <label
                      class="form-check-label small fw-bold text-danger pt-1"
                      for="deleteAvatarSwitch"
                      style="cursor: pointer"
                    >
                      Gỡ ảnh hiện tại
                    </label>
                  </div>
                </div>
                {% endif %} {% if p_form.avatar.errors %}
                <div class="text-danger small mt-2">
                  {{ p_form.avatar.errors }}
                </div>
                {% endif %}
              </div>

              <div class="col-md-8 p-4 p-md-5 profile-right-col">
                <h6 class="text-uppercase text-muted fw-bold mb-3 small ls-1">
                  <i class="fas fa-shield-alt me-2 text-primary"></i>Tài khoản
                </h6>

                <div class="mb-4">
                  <label class="form-label fw-bold">Địa chỉ Email</label>
                  <div class="input-group">
                    <span class="input-group-text border-end-0 bg-transparent"
                      ><i class="fas fa-envelope text-muted"></i
                    ></span>
                    {{ u_form.email|add_class:"form-control border-start-0 ps-0"
                    }}
                  </div>
                  <div class="text-danger small">{{ u_form.email.errors }}</div>
                </div>

                <hr class="my-4 border-light opacity-25" />

                <h6 class="text-uppercase text-muted fw-bold mb-3 small ls-1">
                  <i class="fas fa-id-card me-2 text-primary"></i>Thông tin chi
                  tiết
                </h6>

                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label fw-bold small">Họ và tên</label>
                    {{ p_form.full_name|add_class:"form-control" }}
                  </div>

                  <div class="col-md-6">
                    <label class="form-label fw-bold small">Ngày sinh</label>
                    {{ p_form.date_of_birth|add_class:"form-control" }}
                  </div>

                  <div class="col-md-6">
                    <label class="form-label fw-bold small">Giới tính</label>
                    {{ p_form.gender|add_class:"form-select" }}
                  </div>

                  <div class="col-md-6">
                    <label class="form-label fw-bold small">Dân tộc</label>
                    {{ p_form.ethnicity|add_class:"form-control" }}
                  </div>

                  <div class="col-12">
                    <label class="form-label fw-bold small">Quê quán</label>
                    {{ p_form.hometown|add_class:"form-control" }}
                  </div>

                  <div class="col-12">
                    <label class="form-label fw-bold small">Nghề nghiệp</label>
                    {{ p_form.occupation|add_class:"form-control" }}
                  </div>
                </div>

                <div class="mt-5 text-end">
                  <a href="/" class="btn btn-secondary me-2 fw-bold">Hủy bỏ</a>
                  <button
                    type="submit"
                    class="btn btn-primary px-4 py-2 fw-bold shadow-sm rounded-pill"
                  >
                    <i class="fas fa-save me-2"></i>Lưu hồ sơ
                  </button>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Custom Image Preview Overlay -->
<div id="imagePreviewOverlay" style="display: none">
  <div class="preview-backdrop" onclick="closeImagePreview()"></div>
  <div class="preview-content">
    <button class="preview-close-btn" onclick="closeImagePreview()">
      <i class="fas fa-times"></i>
    </button>
    <img
      id="preview-img"
      src=""
      alt="Preview"
      onclick="event.stopPropagation()"
    />
  </div>
</div>

<style>
  #imagePreviewOverlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 99998;
    display: none;
  }

  #imagePreviewOverlay.active {
    display: block !important;
  }

  .preview-backdrop {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    cursor: pointer;
  }

  .preview-close-btn {
    position: absolute;
    top: -15px;
    right: -15px;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #dc3545;
    border: 2px solid #fff;
    color: white;
    font-size: 18px;
    cursor: pointer;
    z-index: 100000;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
  }

  .preview-close-btn:hover {
    background: #c82333;
    transform: scale(1.1);
  }

  .preview-content {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 99999;
    background: var(--bs-body-bg, #fff);
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    max-width: 600px;
    max-height: 80vh;
    overflow: visible;
    position: relative;
  }

  .preview-content img {
    width: 100%;
    height: auto;
    max-height: 70vh;
    object-fit: cover;
    border-radius: 8px;
    display: block;
  }
</style>

<script>
  function previewImage(input) {
    if (input.files && input.files[0]) {
      var reader = new FileReader();
      reader.onload = function (e) {
        document.getElementById("avatar-preview").src = e.target.result;
        document.getElementById("preview-img").src = e.target.result;
      };
      reader.readAsDataURL(input.files[0]);
    }
  }

  function openImagePreview() {
    var src = document.getElementById("avatar-preview").src;
    document.getElementById("preview-img").src = src;
    document.getElementById("imagePreviewOverlay").classList.add("active");
    document.body.style.overflow = "hidden";
  }

  function closeImagePreview() {
    document.getElementById("imagePreviewOverlay").classList.remove("active");
    document.body.style.overflow = "";
  }

  // Close on ESC key
  document.addEventListener("keydown", function (e) {
    if (e.key === "Escape") {
      closeImagePreview();
    }
  });
</script>
{% endblock %}
